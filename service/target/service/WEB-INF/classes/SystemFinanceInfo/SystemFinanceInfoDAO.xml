<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kemile.SystemFinanceInfo.dao.SystemFinanceInfoDAO">

    <cache type="org.mybatis.caches.ehcache.LoggingEhcache" />

    <sql id="Base_Column_List">
        id
        ,creattime
        ,tao
        ,totalmoney
        ,platformIncome
    </sql>

    <select id="findOne" resultType="com.kemile.SystemFinanceInfo.domain.SystemFinanceInfoEntity">
        SELECT <include refid="Base_Column_List"/> FROM at_income_statistics WHERE ${property} = #{value}
    </select>

    <select id="findList" resultType="com.kemile.SystemFinanceInfo.domain.SystemFinanceInfoEntity">
        SELECT <include refid="Base_Column_List"/>
        FROM at_income_statistics
        WHERE ${property} = #{value}
        <if test="orderBy!=null">
            ORDER BY ${orderBy} ${sortBy}
        </if>
    </select>

    <select id="findAll" resultType="com.kemile.SystemFinanceInfo.domain.SystemFinanceInfoEntity">
        SELECT <include refid="Base_Column_List"/>
        FROM at_income_statistics
        <if test="orderBy!=null">
            ORDER BY ${orderBy} ${sortBy}
        </if>
    </select>

    <select id="queryPage" resultType="java.util.Map">
        SELECT
        s.creattime,
        (SELECT  SUM(tao)  FROM jc_order where order_status='1' and DAY(paymenttime) = DAY(s.creattime) ) as tao,
        SUM(countincome) as totalmoney,
        SUM(agencyincome) as agencyincome ,
        SUM(genincome) as genincome,
        SUM(examincome) as examincome
        from at_income_statistics s
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="condition!=null and condition.creattime!=null">AND creattime=#{condition.creattime}</if>
            <if test="condition!=null and condition.tao!=null">AND tao=#{condition.tao}</if>
            <if test="condition!=null and condition.totalmoney!=null">AND totalmoney=#{condition.totalmoney}</if>
            <if test="condition!=null and condition.platformIncome!=null">AND platformIncome=#{condition.platformIncome}</if>
            <if test="condition!=null and condition.startDate!=null and condition.startDate!=''">
                AND DATE_FORMAT (creattime,'%Y-%m-%d')  &gt;= '${condition.startDate}'
            </if>
            <if test="condition!=null and condition.endDate!=null and condition.endDate!=''">
                AND DATE_FORMAT(creattime,'%Y-%m-%d') &lt;='${condition.endDate}'
            </if>
        </trim>
        GROUP BY DAY(creattime)
        <if test="orderBy!=null">
            ORDER BY ${orderBy} ${sortBy}
        </if>
        LIMIT ${offset}, ${rows}
    </select>

    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM (SELECT
        s.creattime,
        (SELECT  SUM(tao)  FROM jc_order where order_status='1' and DAY(paymenttime) = DAY(s.creattime) ) as tao,
        SUM(countincome) as totalmoney,
        SUM(agencyincome) as agencyincome ,
        SUM(genincome) as genincome,
        SUM(examincome) as examincome
        from at_income_statistics s GROUP BY DAY(creattime) ORDER BY s.creattime DESC) b
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="condition!=null and condition.creattime!=null">AND creattime=#{condition.creattime}</if>
            <if test="condition!=null and condition.tao!=null">AND tao=#{condition.tao}</if>
            <if test="condition!=null and condition.totalmoney!=null">AND totalmoney=#{condition.totalmoney}</if>
            <if test="condition!=null and condition.platformIncome!=null">AND platformIncome=#{condition.platformIncome}</if>
            <if test="condition!=null and condition.startDate!=null and condition.startDate!=''">
                AND DATE_FORMAT (creattime,'%Y-%m-%d')  &gt;= '${condition.startDate}'
            </if>
            <if test="condition!=null and condition.endDate!=null and condition.endDate!=''">
                AND DATE_FORMAT(creattime,'%Y-%m-%d') &lt;='${condition.endDate}'
            </if>
        </trim>
    </select>

    <update id="update">
        UPDATE at_income_statistics
        <trim prefix="SET" suffixOverrides=",">
            <if test="creattime!=null">creattime=#{creattime},</if>
            <if test="tao!=null">tao=#{tao},</if>
            <if test="totalmoney!=null">totalmoney=#{totalmoney},</if>
            <if test="platformIncome!=null">platformIncome=#{platformIncome},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <insert id="insert">
        INSERT INTO at_income_statistics (
        <if test="creattime!=null">creattime,</if>
        <if test="tao!=null">tao,</if>
        <if test="totalmoney!=null">totalmoney,</if>
        <if test="platformIncome!=null">platformIncome,</if>
        )VALUES(
        <if test="creattime!=null">#{creattime},</if>
        <if test="tao!=null">#{tao},</if>
        <if test="totalmoney!=null">#{totalmoney},</if>
        <if test="platformIncome!=null">#{platformIncome},</if>
        )
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID() AS ID
        </selectKey>
    </insert>

    <delete id="deleteByProperty">
        DELETE FROM at_income_statistics WHERE WHERE ${property} = #{value}
    </delete>

    <delete id="deleteById">
        DELETE FROM at_income_statistics WHERE id = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds">
        DELETE FROM at_income_statistics
        <where>
            id IN
            <foreach item="id" index="index" collection="collection" open="(" separator="," close=")">
            #{id}
            </foreach>
        </where>
    </delete>

    <select id="countfinance" resultType="java.util.Map">
        SELECT
        coalesce(agencyshuliangb.agencyshuliang,0) AS agencyshuliang,
        coalesce(shifanshuliangb.shifanshuliang,0) AS shifanshuliang,
        coalesce(ptongshuliangb.ptongshuliang,0) AS ptongshuliang,
        coalesce(counttaob.counttao,0) AS counttao,
        coalesce(countxiaoshouet.countxiaoshoue,0) AS countxiaoshoue,
        coalesce(todyt.todytao,0) AS todytao,
        coalesce(yestadyt.yestadytao,0) AS yestadytao,
        coalesce(sevtadyt.sevtadytao,0) AS sevtadytao,
        coalesce(stytadyt.stytadyao,0) AS stytadyao,
        coalesce(agencycountshourue.agencyincome,0) AS agencyincome,
        coalesce(countxiaoshouet.countxiaoshoue-agencycountshourue.examincome-agencycountshourue.agencyincome-agencycountshourue.genincome,0) AS zongshouru
        FROM
        (SELECT COUNT(*) AS agencyshuliang FROM jc_agency)AS agencyshuliangb,
        (SELECT COUNT(*) AS shifanshuliang FROM d_school WHERE type="shifan") AS shifanshuliangb,
        (SELECT COUNT(*) AS ptongshuliang FROM d_school WHERE type="putong") AS ptongshuliangb,
        (SELECT SUM(tao) AS counttao FROM jc_order WHERE order_status=1) AS counttaob ,
        (SELECT sum(totalmoney) AS countxiaoshoue FROM jc_order WHERE order_status=1)AS countxiaoshouet,
        (SELECT SUM(tao) AS todytao FROM jc_order WHERE order_status=1 AND DATE_FORMAT(NOW(),"%y-%m-%d")=DATE_FORMAT(committime, "%y-%m-%d")) AS todyt,
        (SELECT SUM(tao) AS yestadytao FROM jc_order WHERE order_status=1 AND date_sub(curdate(),interval 1 day)=DATE_FORMAT(committime, "%y-%m-%d")) AS yestadyt,
        (SELECT SUM(tao) AS sevtadytao FROM jc_order WHERE order_status=1 AND date_sub(curdate(),interval 7 day) &lt; DATE_FORMAT(committime, "%y-%m-%d")) AS sevtadyt,
        (SELECT SUM(tao) AS stytadyao FROM jc_order WHERE order_status=1 AND date_sub(curdate(),interval 30 day) &lt; DATE_FORMAT(committime, "%y-%m-%d")) AS stytadyt,
        (SELECT sum(agencyincome) AS agencyincome,SUM(examincome) AS examincome,SUM(genincome) AS genincome FROM at_income_statistics) AS agencycountshourue
    </select>
</mapper>