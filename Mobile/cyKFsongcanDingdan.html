<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    <title>提交订单</title>
    <link rel="stylesheet" href="css/drawer.css">
    <!-- menu -->
    <link rel="stylesheet" href="css/aui.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/qr_base.css">
    <link rel="stylesheet" href="css/common.css">
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/iscroll.js"></script>
    <!-- menu -->
    <script type="text/javascript" src="js/jquery.drawer.min.js"></script>
    <!-- menu -->
    <script type="text/javascript" src="js/js.js"></script>
    <!-- 网站js -->
    <!--weiui -->
    <link rel="stylesheet" href="css/weui.min.css">
    <script type="text/javascript" src="js/router.min.js"></script>
    <script type="text/javascript" src="js/zepto.min.js"></script>
    <script type="text/javascript" src="js/weui_example.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>
    <script type="text/javascript" src="lib/layer/2.1/layer.js"></script><!-- 网站js -->
</head>
<style type="text/css">
    .cantingname {
        margin-bottom: 15px;
        hetght: 60px;
    }

    .yhjsuojin {
        text-indent: 10px;
    }

    .img {
        width: 60px;
        height: 60px;
        border: 1px solid #e5e5e5;
    }

    .spanname {
        width: 70%;
    }
</style>

<body ontouchstart="" class="drawer drawer-right">
<div class="viewport">
    <header class="aui-bar aui-bar-nav">
        <a class="aui-pull-left" href="javascript:history.back();">
            <span class="aui-iconfont aui-icon-left"></span>
        </a>
        <div class="aui-title">提交订单</div>
        <a class="aui-pull-right drawer-toggle">
            <span class="aui-iconfont aui-icon-sort"></span>
        </a>
    </header>
    <!-- 侧边导航开始 -->
    <div class="drawer-main drawer-default">
        <nav class="drawer-nav" role="navigation">
            <!-- 未登录 -->
            <div id="div_noLogin" class="touxiang">
                <a href="javascript:userImgClick('userIndex.html')" class="touxiangimg"><img src="images/touxiang.png" width="100%"></a>
                <span><a href="index.html?gologin=1">登录</a><a href="index.html?gologin=2">注册</a></span>
            </div>
            <!-- 登录后 -->
            <div id="div_okLogin" class="touxiang" style="display:none;">
                <a href="userIndex.html" class="touxiangimg"><img src="images/touxiang.png" id="cetoux" width="100%" style="margin-top:2px;box-shadow:0px 0px 12px #7E7E7E;"></a>
                <span>jack</span>
                <span>黄金会员</span>
            </div>
            <ul class="drawer-nav-list">
                <li><a href="javascript:gotoUrl('index.html')"><i class="aui-iconfont aui-icon-homefill"></i>返回首页</a></li>
                <li><a href="javascript:gotoUrl('userIndex.html')"><i class="menuicon1"></i>会员中心</a></li>
                <li><a href="javascript:gotoUrl('dfZhitongcheInfo.html')"><i class="menuicon2"></i>订房直通车</a></li>
                <li><a href="javascript:gotoUrl('cyYongcanFangshi.html')"><i class="menuicon3"></i>餐饮订制</a></li>
                <li><a href="javascript:gotoService('kfFuwu.html')"><i class="menuicon4"></i>客房服务</a></li>
                <li><a href="javascript:gotoService('lbFuwu.html')"><i class="menuicon5"></i>礼宾服务</a></li>
                <li><a href="javascript:gotoService('kfyanzhu.html')"><i class="menuicon6"></i>客房延住</a></li>
                <li><a href="javascript:gotoService('ksTuifang.html')"><i class="menuicon7"></i>快速退房</a></li>
                <li><a href="javascript:gotoUrl('dnDaohang.html')"><i class="menuicon8"></i>店内导航</a></li>
                <li><a href="javascript:gotoUrl('jdList.html')"><i class="menuicon9"></i>周边信息</a></li>
                <li><a href="javascript:gotoUrl('sdJiabinhui.html')"><i class="menuicon10"></i>首都嘉宾会</a></li>
                <li><a href="javascript:gotoUrl('userJifenShangcheng.html')"><i class="menuicon11"></i>积分商城</a></li>
            </ul>
        </nav>
    </div>
    <!-- 侧边导航结束 -->
    <dl class="shuxinglist cantingname aui-border-b">
        <dd id="hyName">姓名：--</dd>
        <dd id="hyTel">电话：--</dd>
        <dd id="hyRoom">--</dd>
    </dl>
    <!-- <div class="aui-content">
         <ul class="aui-list-view ">
             <li class="aui-list-view-cell">
                 <a class="aui-arrow-right yhjsuojin" href="cyYouhuijuan.html">
                     优惠券
                     <span class="aui-badge nobg c_8">有<i class="c_yellow">2</i>张优惠券可用</span>
                 </a>
             </li>
         </ul>
     </div>-->
    <!-- 菜单列表 开始 -->
    <div class="cailist aui-border-t aui-border-b">
        <div id="disList">

            <!--            <li class="aui-border-b">
                            <span class="name"><img class="img" src="images/cai.jpg"/>土豆丝</span>
                            <span class="num">x2</span>
                            <span class="price c_red">￥48</span>
                        </li>
                        <li class="aui-border-b">
                            <span class="name"><img class="img" src="images/cai.jpg"/>手撕包菜</span>
                            <span class="num">x2</span>
                            <span class="price c_red">￥48</span>
                        </li>-->
        </div>
        <span class="zongjia ar f_size16" >菜品总金额<i class="c_red" id="dishesMoney"></i></span>
        <span class="zongjia ar f_size16" >服务费<i class="c_red" id="fuwufei"></i></span>
        <span class="zongjia ar f_size16">总金额<i class="c_red" id="count"></i>
            <small>(含<small id="bili"></small>%服务费)</small>
        </span>
    </div>
    <!-- 菜单列表 结束 -->
    <!-- 操作容器 -->
    <div class="padbottom"></div>
    <div class="bottomcaozuo aui-border-t">
        <span class="f_size18 price">合计￥<i class="c_red" id="amount"></i></span><a href="#" onclick="saveOrder()"
                                                                                   class="aui-btn aui-btn-primary fr">提交订单Submit</a>
    </div>
</div>
<script type="text/javascript" src="scripts/app.js"></script>
<!--<script type="text/javascript" src="scripts/cyTijiaoDingdan.js"></script>-->
<script type="text/javascript">
    var cyJsonStr;
    var orderPrice;
    var sumpri;//含服务费的价格
    $(function () {
        var json = JSON.parse($.getUrlParam("json"));
        saveCollection($.getUrlParam("json"));
        cyJsonStr = $.getUrlParam("json");
        var ids = [];
        var cyJson = {};
        for (var i = 0; i < json.length; i++) {
            var cid = json[i].cid
            ids.push(json[i].cid);
            cyJson["" + cid + ""] = json[i].cid.count;
        }
        $("#hyName").html("姓名：" + MemberInfo.name);
        $("#hyTel").html("电话：" + MemberInfo.phone);
        if(empty(RoomInfo)){
            $("#hyRoom").html("房间：<span style='color: #f3424c'>没有进行房号验证所以获取不到房间号</span>");
        }else{
            $("#hyRoom").html("房间：" + RoomInfo.room + "号房间");
        }
    });

    function saveCollection(json) {
        var url = "/CyDishEntity/queryOrderPriceByDish";
        var successFun = function (data) {
            var datas = data.bizData;
            var html = "";
            var sumPrice = 0;
//            for (var i = 0; i < datas.length; i++) {
//                var dis = datas[i];
//                html += "<li class='aui-border-b'>"
//                        + " <span class='name spanname'>"
//                        + dis.name + "</span>"
//                        + " <span class='num'>x" + dis.count + "</span>"
//                        + "  <span class='price c_red'>￥" + dis.sum + "</span>"
//                        + "</li>";
//                sumPrice += dis.sum;
//            }
//            orderPrice = sumPrice;
             charge(datas);//查询服务费比例

        };
        ajaxPostFun(url, {"rantId": "212", "json": json}, successFun, null, "获取菜品信息");
    }//

    function charge(datas){
        var serurl="/System/SerCharge/findBySerStatus";
        var ratio;
        var accAdds;
        var success = function (data) {
            if(data.bizData.length>0){
                ratio=data.bizData[0].ratio;
                var html = "";
                var sumPrice = 0;
                var servicePrice=0;
                for (var i = 0; i < datas.length; i++) {
                    var dis = datas[i];
                    html += "<li class='aui-border-b'>"
                            + " <span class='name spanname'>"
                            + dis.name + "</span>"
                            + " <span class='num'>x" + dis.count + "</span>"
                            + "  <span class='price c_red'>￥" + dis.sum + "</span>"
                            + "</li>";

                    sumPrice += dis.sum;
                    $("#dishesMoney").html(sumPrice); //菜品总金额
                }
                servicePrice=sumPrice*ratio/100;
                var accDivs=accDiv(ratio,100);
                var accMuls=accMul(accDivs,sumPrice);
                sumpri=accAdd(accMuls,sumPrice);
                orderPrice = sumpri;
                $("#count").html("￥" + sumpri.toFixed(1));
                $("#fuwufei").html("￥" + servicePrice.toFixed(1));
                $("#bili").html(ratio);
                $("#amount").html(sumpri.toFixed(1));
                $("#disList").append(html);
            }else{
                var html = "";
                var sumPrice = 0;
                for (var i = 0; i < datas.length; i++) {
                    var dis = datas[i];
                    html += "<li class='aui-border-b'>"
                            + " <span class='name spanname'>"
                            + dis.name + "</span>"
                            + " <span class='num'>x" + dis.count + "</span>"
                            + "  <span class='price c_red'>￥" + dis.sum + "</span>"
                            + "</li>";
                    sumPrice += dis.sum;
                }
                orderPrice = sumPrice
                $("#count").html("￥" + sumPrice);
                $("#amount").html(sumPrice);
                $("#disList").append(html);
            }
        }
        ajaxPostFun(serurl,{},success,null,"查询服务费")

    }
        //提交订单
    function saveOrder(json) {
        if (empty(RoomInfo)){
            weui.alert("你还没有进行房间验证不能操作此项！");
        }else{
            var url2 = "/cyDishorder/saveCyDcOrder";

            var data = {
                "hotelCode": "capital",
                "json": cyJsonStr,
                "hyName": MemberInfo.name,
                "hyTel": MemberInfo.phone,
                "hyRoom": RoomInfo.room,
                "orderPrice": orderPrice,
                "dishesMoney": $("#dishesMoney").text(),
                "serviceMoney": $("#fuwufei").text().substring(1),
                "serviceRatio": $("#bili").text()
            };
            //alert(data.dishesMoney);
            var successFunc = function (data) {
                if (data.rtnCode = "0000000") {
                    window.location = "cyLijiZhifu.html?price="+orderPrice+"&orderId=" + data.bizData;
                }
            };
            ajaxPostFun(url2, data, successFunc, null, "获取菜品信息");
        }
    }

    //说明：javascript的加法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的加法结果。
    //调用：accAdd(arg1,arg2)
    //返回值：arg1加上arg2的精确结果
    function accAdd(arg1,arg2){
        var r1,r2,m;
        try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
        try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
        m=Math.pow(10,Math.max(r1,r2))
        return (arg1*m+arg2*m)/m
    }
    //说明：javascript的乘法结果会有误差，在两个浮点数相乘的时候会比较明显。这个函数返回较为精确的乘法结果。
    //调用：accMul(arg1,arg2)
    //返回值：arg1乘以arg2的精确结果
    function accMul(arg1,arg2)
    {
        var m=0,s1=arg1.toString(),s2=arg2.toString();
        try{m+=s1.split(".")[1].length}catch(e){}
        try{m+=s2.split(".")[1].length}catch(e){}
        return Number(s1.replace(".",""))*Number(s2.replace(".",""))/Math.pow(10,m)
    }
    //说明：javascript的除法结果会有误差，在两个浮点数相除的时候会比较明显。这个函数返回较为精确的除法结果。
    //调用：accDiv(arg1,arg2)
    //返回值：arg1除以arg2的精确结果
    function accDiv(arg1,arg2){
        var t1=0,t2=0,r1,r2;
        try{t1=arg1.toString().split(".")[1].length}catch(e){}
        try{t2=arg2.toString().split(".")[1].length}catch(e){}
        with(Math){
            r1=Number(arg1.toString().replace(".",""))
            r2=Number(arg2.toString().replace(".",""))
            return (r1/r2)*pow(10,t2-t1);
        }
    }
</script>
</body>

</html>
